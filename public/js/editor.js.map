{"version":3,"sources":["public/src/components/utils.ts","public/src/components/texteditor.ts","public/src/utils/loadDocument.ts","public/src/editor.ts","public/src/utils/document.ts"],"names":["pixelFields","div","style","Object","keys","forEach","k","is_number","indexOf","type","styleOrClass","__style","__className","document","createElement","className","applyStyle","msg","clases","utils_1","classList","add","contentEditable","innerHTML","result","constructor","doc","itemes","Map","changed","onChange","e","get","target","id","innerText","onSave","save","then","console","log","error","containner","append","spanMsg","size","span","addEventListener","toString","set","clearMark","el","children","remove","mark","mensajes","length","push","editor","TextEditor","i","room_id","Promise","resolve","reject","blob","fetch","r","catch","err","json","jdoc","document_1","text","split","filter","f","trim","map","j","JSON","parse","clean","Error","raw","samples","blockSize","Math","floor","filtered","start","sum","abs","multiplier","pow","max","normalized","n","audioBuffer","getChannelData","generarSamplesFromArray","buffer","context","AudioContext","decodeAudioData","canvas","normalizedData","dpr","window","devicePixelRatio","padding","width","offsetWidth","height","offsetHeight","ctx","getContext","clearRect","scale","translate","fillStyle","x","h","fillRect","sessionId","loadDocument_1","margin","visualization","photo","background","img","photoUrl","src","onclick","input","accept","onchange","image_file","files","form","FormData","roomId","method","body","res","click","audioControls","marginTop","playPauseButton","downloadAudioButton","marginLeft","decodeAudio","arrayBuffer","generarSamples","drawHorizontal","texteditor_1","source","onmousemove","strokeStyle","lineWidth","moveTo","offsetX","lineTo","stroke","progress","segundos","duration","after_this","near","offset","stop","createBufferSource","connect","destination","playAudio","a","appendChild","display","url","URL","createObjectURL","href","download","revokeObjectURL","removeChild","sessions","build","roomIdOrDocument","second","candidates","times","m","values","find","headers","stringify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAAMA,eAAe,UAAU,cAAc,eAAe,aAAY,gBACpE,WAAW,eAAe,gBAAgB,cAAa,iBACvD,QAAQ,OAAO,SAAS,UAAS,SAAQ,UAAU,YAAY,aAC/D,YAAY,aAAa;AACtB,oBAAoBC,KAAkBC;EACzCC,OAAOC,KAAKF,eAAaG,QAAQC,AAAA;QACzBC,YAAYP,YAAYQ,QAAQF,MAAM;QACtCC,oBAAoBL,MAAMI,MAAM,UAAUL,IAAIC,MAAMI,KAAKJ,MAAMI,KAAG,WACjEL,IAAIC,MAAMI,KAAKJ,MAAMI;;;;wBAWW,CAACG,MAAcC,cAAgCR;MACpFS,iBAAiBD,gBAAgB,WAAUA,eAAeR;MAC1DU,qBAAqBF,gBAAgB,WAAUA,eAAe;MAC9DT,MAAMY,SAASC,cAAcL;EACjCR,IAAIc,YAAYH;EAChBI,WAAWf,KAAKU;SACTV;;AAGJ,mBAAmBS,cAAgCR;MAClDS,iBAAiBD,gBAAgB,WAAUA,eAAeR;MAC1DU,qBAAqBF,gBAAgB,WAAUA,eAAe;MAC9DT,MAAMY,SAASC,cAAc;EACjCb,IAAIc,YAAYH;EAChBI,WAAWf,KAAKU;SACTV;;;;;;;;;;AC9BX,cAAcgB,KAAWC,SAAS;MAC1BjB,MAAMkB,kBAAU;MAChBD,QAAQjB,IAAImB,UAAUC,IAAIH;EAC9BjB,IAAIqB,kBAAkB;EACtBrB,IAAIsB,YAAYN,IAAIO;SACbvB;;AAGX;EAOIwB,YAAYC,KAA4BzB;SALxC0B,aAAyDC;SAEzDC,UAAU;SA0BVC,WAAW,AAACC;MACR,KAAKL,IAAIM,IAAID,EAAEE,OAAOC,IAAIV,SAASO,EAAEE,OAAOE;MAC5C,KAAKN,UAAU;;SAEnBO,SAAS,AAACL;UACF,KAAKF;QACL,KAAKH,IAAIW,OAAOC,KAAKC,QAAQC,KAAKD,QAAQE;QAC1C,KAAKZ,UAAU;;;IA7BnB,KAAKa,aAAazC;IAClB,KAAKyB,MAAMA;;EAEfiB,OAAO1B;QACC2B;QACA,KAAKjB,OAAOkB,QAAQ,GAAGD,UAAUE,KAAK7B,KAAK,eAC1C2B,UAAUE,KAAK7B;IACpB2B,QAAQG,iBAAiB,SAAS,KAAKjB;IACvCc,QAAQG,iBAAiB,QAAQ,KAAKX;QAClCF,KAAKjB,IAAIiB,GAAGc;IAChBJ,QAAQV,KAAKA;IACb,KAAKP,OAAOsB,IAAIf;MAAKjC,KAAK2C;MAAS3B;;IACnC,KAAKyB,WAAWC,OAAOC;;EAE3BM;aACaC,MAAM,KAAKT,WAAWU,UAAUD,GAAG/B,UAAUiC,OAAO;WACtD;;EAEXC,KAAKpB;IACD,KAAKP,OAAOK,IAAIE,IAAIjC,IAAImB,UAAUC,IAAI;WAC/B;;;AAcR,2BAA2BK,KAA4BgB;MACtDa;WAEKtC,OAAOS,IAAIC;QACZ4B,SAASC,UAAUD,SAASA,SAASC,SAAO,GAAGtB,MAAMjB,IAAIiB;MACzDqB,SAASA,SAASC,SAAO,KAAKvC;;MAE9BsC,SAASE,KAAKxC;;;MAIlBhB,MAAMkB,kBAAU;MAEhBuC,aAAaC,WAAWjC,KAAKzB;WAExB2D,IAAI,GAAGA,IAAIL,SAASC,QAAQI;QAC7B3C,MAAMsC,SAASK;IACnBF,OAAOf,OAAO1B;;EAGlByB,WAAWC,OAAO1C;SACXyD;;;;;;;;;;ACzEJ,kBAAkBG;aACVC,QAAuC,OAAOC,SAASC;;YAEpDC,aAAaC,gBAAgBL,WAAWvB,KAAK6B,AAAA,KAAKA,EAAEF,QAAQG,MAAMC,AAAA,OAAO;UAC3EJ,MAAM1B,QAAQC,IAAIyB,KAAKpB,MAAMgB;WAC5BI,QAAQA,KAAKpB,OAAO;MAEzBqB,4BAA4BL,WAAWvB,KAAK6B,AAAA,KAAKA,EAAEG,QAAQhC,KAAM,AAACiC;YAC1D7C,UAAU8C,iCAAsBD,KAAK/C;QACzCuC,SAAUE,MAAMvC;SACjB0C,MAAMC,AAAA;eAEEH,wBAAwBL,WAAWvB,KAAK6B,AAAA,KAAKA,EAAEM,QAAQnC,KAAKmC,AAAA;cAC3DH,OAAOG,KAAKC,MAAM,MAAMC,OAAOC,AAAA,KAAKA,EAAEC,OAAOrB,QAAQsB,IAAIC,AAAA,KAAKC,KAAKC,MAAMF;cACzErD,UAAU8C,iCAAsBX,SAASS;UAC7C5C,IAAIwD;UACJnB,SAAUE,MAAMvC;WACjB0C,MAAMC,AAAA;oBACKc,MAAM,yCAAuCd;;;aAI3DA;MACJL,OAAOK;;;;;;;;;;;;;;ACpBnB,iCAAiCe,KAAmBC,UAAU;QACpDC,YAAYC,KAAKC,MAAMJ,IAAI5B,SAAO6B;QAClCI;WACG7B,IAAI,GAAGA,IAAIyB,SAASzB;QACrB8B,QAAQJ,YAAY1B;QACpB+B,MAAM;aACDZ,IAAI,GAAGA,IAAIO,WAAWP;MAC3BY,OAAOJ,KAAKK,IAAIR,IAAIM,QAAMX;;IAE9BU,SAAShC,KAAKkC,MAAIL;;QAEhBO,aAAaN,KAAKO,IAAIP,KAAKQ,OAAON,YAAY;QAC9CO,aAAaP,SAASX,IAAImB,AAAA;WACrBA,IAAIJ;;SAERG;;AAEX,wBAAwBE,aAA0Bb,UAAU;QAClDD,MAAMc,YAAYC,eAAe;SAChCC,wBAAwBhB,KAAKC;;AAExC,qBAAqBgB;MACbC,cAAcC;SACXD,QAAQE,gBAAgBH,QAC9B/D,KAAK4D,AAAA;WACKA;;;AAIf,wBAAwBO,QAA2BC;QACzCC,MAAMC,OAAOC,oBAAoB;QACjCC,UAAU;EAChBL,OAAOM,QAAQN,OAAOO,cAAcL;EACpCF,OAAOQ,UAAUR,OAAOS,eAAeJ,UAAU,KAAMH;QACjDQ,MAAMV,OAAOW,WAAW;EAC9BD,IAAIE,UAAU,GAAE,GAAEZ,OAAOM,OAAON,OAAOQ;EACvCE,IAAIG,MAAMX,KAAKA;EACfQ,IAAII,UAAW,GAAGd,OAAOS,eAAe,IAAIJ;QAGtCC,QAAQN,OAAOO,cAAcN,eAAelD;EAClD2D,IAAIK,YAAY;WACP5D,IAAI,GAAGA,IAAI8C,eAAelD,QAAQI;QACnC6D,IAAIV,QAAQnD;QACZ8D,IAAIhB,eAAe9C,KAAK6C,OAAOS,eAAeJ;QAC9CY,IAAE,GAAGA,IAAI;QACT9D,IAAE,KAAK,KAAK8D,IAAI,GAAGA,KAAKA;IAE5BP,IAAIQ,SAASF,GAAE,GAAEV,OAAMW;;;AAK/B,qBAAqBE;OACZ3D,MAAMvC,aAAamG,wBAASD;OAE5B3D,QAAQA,KAAKpB,OAAO;EACzBN,QAAQC,IAAIyB,KAAKpB;MAGb5C,MAAMkB;IAAW4F,OAAO;IAAKe,QAAQ;;QACnCC,gBAAgB5G,kBAAU;QAC1BsF,SAAS5F,SAASC,cAAc;EACtC2F,OAAOrF,UAAUC,IAAI;EACrBoF,OAAOvG,MAAM6G,QAAQ;EACrBN,OAAOvG,MAAM+G,SAAS;EACtBc,cAAcpF,OAAO8D;EACrBxG,IAAI0C,OAAOoF;QAELC,QAAQ7G;IAAW8F,QAAQ;IAAKF,OAAO;IAAQkB,YAAY;IAAaH,QAAQ;;MAElFI,MAAM/G,sBAAc;IAAQ4F,OAAO;;MACnCrF,IAAIyG,UAAUD,IAAIE,MAAM1G,IAAIyG;EAChCH,MAAMrF,OAAOuF;EAEbF,MAAMK,UAAU;QACRC,QAAQnH,sBAAc;IAC1BmH,MAAM7H,OAAO;IACb6H,MAAMC,SAAS;IACfD,MAAME,WAAW,AAACzG;UACV0G,aAAa1G,EAAEE,OAAOyG,MAAM;UAC5BC,WAAWC;MACfD,KAAKhG,OAAO,QAAQ8F;MACpBvE,qBAAqBxC,IAAImH;QAAWC,QAAQ;QAAQC,MAAMJ;SACzDrG,KAAK6B,AAAA,KAAKA,EAAEG,QAAQhC,KAAK0G,AAAA;QACtBtH,IAAIyG,WAAWa,IAAIxH;QACnB0G,IAAIE,MAAM1G,IAAIyG;QACdzG,IAAIW,OAAOC,KAAKC,QAAQC,KAAKD,QAAQE;SAGtCF,QAAQE;;IAEf6F,MAAMW;;EAEVhJ,IAAI0C,OAAOqF;QAELkB,gBAAgB/H,kBAAU;IAAegI,WAAW;;QACpDC,kBAAkBjI,sBAAc;IAAW4F,OAAO;IAAKE,QAAQ;;EACrEmC,gBAAgBjH,YAAY;EAC5B+G,cAAcvG,OAAOyG;QACfC,sBAAsBlI,sBAAc;IAAW4F,OAAO;IAAKE,QAAQ;IAAIqC,YAAY;;EACzFD,oBAAoBlH,YAAY;EAChC+G,cAAcvG,OAAO0G;EAGrBpJ,IAAI0C,OAAOuG;EACXrI,SAASkI,KAAKpG,OAAO1C;QAGfiG,oBAAoBqD,kBAAkBtF,KAAKuF;QAC3CxD,aAAayD,eAAevD;EAClCwD,eAAejD,QAAQT;MAGnBtC,SAASiG,+BAAkBjI,KAAKb,SAASkI;MACzCzC,cAAcC;MACdqD;EAEJnD,OAAOoD,cAAc9H,AAAA;IACjB2H,eAAejD,QAAQT;QACnBmB,MAAMV,OAAOW,WAAW;IAC5BD,IAAI2C,cAAc;IAClB3C,IAAI4C,YAAY;IAChB5C,IAAI6C,OAAOjI,EAAEkI,UAAUxD,OAAOQ,SAAO;IACrCE,IAAI+C,OAAOnI,EAAEkI,SAASxD,OAAOQ,SAAO;IACpCE,IAAIgD;QAGAC,WAAWrI,EAAEkI,UAAQxD,OAAOM;QAC5BsD,WAAWnE,YAAYoE,WAAWF;QAGlCG,aAAa7I,IAAI8I,KAAKH;QACtBE,WAAW/G;MACXE,OAAOR,YAAYI,KAAKiH,WAAW,GAAGrI,GAAGc;;;EAIjD,mBAAmByH;QACXb,QAAQA,OAAOc;IACnBtB,gBAAgBjH,YAAY;IAC5ByH,SAAStD,QAAQqE;IACjBf,OAAOvD,SAASH;IAChB0D,OAAOgB,QAAQtE,QAAQuE;IACvBjB,OAAOlE,MAAM,GAAG+E;;EAEpBhE,OAAO4B,UAAU,AAACtG;QACVqI,WAAWrI,EAAEkI,UAAQxD,OAAOM;QAC5BsD,WAAWnE,YAAYoE,WAAWF;QAElCnI,SAASP,IAAI8I,KAAKH;QAClBpI,OAAOuB,QAAQsH,UAAW7I,OAAO,GAAGC,KAAK;;EAEjDkH,gBAAgBf,UAAU;QAClBuB;MACAA,OAAOc;MACPd,SAAS;MACTR,gBAAgBjH,YAAY;WACzB2I,UAAU;;EAErBzB,oBAAoBhB,UAAU;QACtB0C,IAAIlK,SAASC,cAAc;IAC/BD,SAASkI,KAAKiC,YAAYD;IAC1BA,EAAE7K,MAAM+K,UAAU;QACdC,MAAMtE,OAAOuE,IAAIC,gBAAgBnH;IACrC8G,EAAEM,OAAOH;IACTH,EAAEO,WAAW5J,IAAImH,SAAO;IACxBkC,EAAE9B;IACFrC,OAAOuE,IAAII,gBAAgBL;IAC3BrK,SAASkI,KAAKyC,YAAYT;;;SAKzBnD,aAAa6D;EAClBC,MAAM9D;;;;;;;AC7KH;EAIHnG,YAAYkK,kBAAkDhK;SAH9DkH,SAAiB;SACjBlH;SACAwG,WAAmB;eAEJwD,oBAAoB;MAC3B,KAAK9C,SAAS8C;MACd,KAAKhK,SAASA;;MAEd,KAAKkH,SAAS8C,iBAAiB9C;MAC/B,KAAKlH,SAASgK,iBAAiBhK,UAAUA;MACzC,KAAKwG,WAAWwD,iBAAiBxD;;;EAIzCqC,KAAKoB;QACGC,aAAa,KAAKlK,OAAOgD,OAAOC,AAAA;aACzBA,EAAE1C,KAAK0J,SAAO;;QAErBC,WAAWrI,eAAeqI,qBACrB,KAAKlK,OAAO6B,gBAAgB,KAAK7B,OAAO,KAAKA,OAAO6B,SAAO;;;EAGxE0B;QACQ4G;aACKC,KAAK,KAAKpK;MACfmK,MAAMC,EAAE7J,MAAM6J;;IAElB,KAAKpK,SAASxB,OAAO6L,OAAOF;;EAEhC9J,IAAIE;WACO,KAAKP,OAAOsK,KAAKrH,AAAA,KAAKA,EAAE1C,GAAGc,cAAcd;;EAEpDG;WACW6B,4BAA4B,KAAK2E;MAAWC,QAAQ;MAAQoD;QAAU,gBAAgB;;MAAqBnD,MAAM/D,KAAKmH,UAAU;OAAQ7J,KAAK6B,AAAA,KAAKA,EAAEG","file":"","sourcesContent":["const pixelFields = [\"margin\", \"marginLeft\", \"marginRight\", \"marginTop\",\"marginBottom\", \r\n    \"padding\", \"paddingLeft\", \"paddingRight\", \"paddingTop\",\"paddingBottom\",\r\n    \"left\", \"top\", \"right\", \"bottom\",\"width\",\"height\", \"minWidth\", \"minHeight\", \r\n    \"maxWidth\", \"maxHeight\", \"borderWidth\"]\r\nexport function applyStyle(div: HTMLElement, style: any) {\r\n    Object.keys(style || {}).forEach(k => {\r\n        let is_number = pixelFields.indexOf(k) >= 0\r\n        if (is_number && typeof style[k] == \"number\") div.style[k] = style[k]+\"px\"\r\n        else div.style[k] = style[k]\r\n   \r\n    })\r\n}\r\n\r\n\r\ninterface  ICreateElement {\r\n    (type: \"button\", styleOrClass?: string | object, style?: object): HTMLButtonElement;\r\n    (type: \"div\", styleOrClass?: string | object, style?: object): HTMLDivElement;\r\n    (type: string, styleOrClass?: string | object, style?: object): HTMLElement;\r\n}\r\nexport const createElement: ICreateElement = (type: string, styleOrClass?: string | object, style?: object) => {\r\n    var __style = typeof styleOrClass == \"object\"? styleOrClass : style || {}\r\n    var __className = typeof styleOrClass == \"string\"? styleOrClass : \"\"\r\n    var div = document.createElement(type)\r\n    div.className = __className\r\n    applyStyle(div, __style)\r\n    return div as any\r\n} \r\n\r\nexport function createDiv(styleOrClass?: string | object, style?: object) {\r\n    var __style = typeof styleOrClass == \"object\"? styleOrClass : style || {}\r\n    var __className = typeof styleOrClass == \"string\"? styleOrClass : \"\"\r\n    var div = document.createElement(\"div\")\r\n    div.className = __className\r\n    applyStyle(div, __style)\r\n    return div\r\n}\r\n","import { IMsg, TranscriptionDocument } from \"../utils/document\";\r\nimport { createDiv } from \"./utils\";\r\n\r\n\r\nfunction span(msg: IMsg, clases = null) {\r\n    var div = createDiv(\"span\");\r\n    if (clases) div.classList.add(clases)\r\n    div.contentEditable = \"true\";\r\n    div.innerHTML = msg.result\r\n    return div\r\n}\r\n\r\nclass TextEditor {\r\n    containner: HTMLElement;\r\n    itemes: Map<string, {div: HTMLElement, msg: IMsg}> = new Map();\r\n    doc: TranscriptionDocument;\r\n    changed = false;\r\n\r\n\r\n    constructor(doc: TranscriptionDocument, div: HTMLElement) {\r\n        this.containner = div;   \r\n        this.doc = doc;  \r\n    }\r\n    append(msg: IMsg) {\r\n        let spanMsg: HTMLElement;\r\n        if (this.itemes.size == 0) spanMsg = span(msg, \"title\")\r\n        else spanMsg = span(msg)\r\n        spanMsg.addEventListener(\"input\", this.onChange)\r\n        spanMsg.addEventListener(\"blur\", this.onSave)\r\n        let id = msg.id.toString();\r\n        spanMsg.id = id;  \r\n        this.itemes.set(id, {div: spanMsg, msg})\r\n        this.containner.append(spanMsg)  \r\n    }\r\n    clearMark() {\r\n        for (let el of this.containner.children) el.classList.remove(\"selected\")\r\n        return this\r\n    }\r\n    mark(id: string) {\r\n        this.itemes.get(id).div.classList.add(\"selected\")\r\n        return this\r\n    }\r\n    onChange = (e) => {\r\n        this.doc.get(e.target.id).result = e.target.innerText;\r\n        this.changed = true;\r\n    }\r\n    onSave = (e) => {\r\n        if (this.changed) {\r\n            this.doc.save().then(console.log, console.error)\r\n            this.changed = false\r\n        }\r\n    }\r\n}\r\n\r\nexport function generarTextEditor(doc: TranscriptionDocument, containner: HTMLElement) {\r\n    var mensajes: IMsg[] = [];\r\n\r\n    for (let msg of doc.itemes) {\r\n        if (mensajes.length && mensajes[mensajes.length-1].id == msg.id) {\r\n            mensajes[mensajes.length-1] = msg;\r\n        } else {\r\n            mensajes.push(msg)\r\n        }\r\n    }\r\n\r\n    var div = createDiv(\"textEditor\");\r\n    //div.contentEditable = \"true\";\r\n    var editor = new TextEditor(doc, div)\r\n\r\n    for (let i = 0; i < mensajes.length; i++) {\r\n        let msg = mensajes[i]\r\n        editor.append(msg)\r\n    }\r\n\r\n    containner.append(div)\r\n    return editor;\r\n}","import { TranscriptionDocument } from \"./document\"\r\n\r\nexport function loadData(room_id: string): Promise<[Blob, TranscriptionDocument]>{\r\n    return new Promise<[Blob, TranscriptionDocument]>(async (resolve, reject) => {\r\n        try {\r\n            const blob = await fetch(`/audio/${room_id}`).then(r => r.blob()).catch(err => null)\r\n            if (blob) console.log(blob.size, room_id)\r\n            if (!blob || blob.size < 1000) return;\r\n\r\n            fetch(`/api/transcripcion/${room_id}`).then(r => r.json()).then( (jdoc: {result: TranscriptionDocument}) => {\r\n                var doc = new TranscriptionDocument(jdoc.result)\r\n                resolve( [blob, doc] )\r\n            }).catch(err => {\r\n\r\n                return fetch(`/transcripcion/${room_id}`).then(r => r.text()).then(text => {\r\n                    var json = text.split(\"\\n\").filter(f => f.trim().length).map(j => JSON.parse(j))\r\n                    var doc = new TranscriptionDocument(room_id, json)\r\n                    doc.clean()\r\n                    resolve( [blob, doc] )\r\n                }).catch(err => {\r\n                    throw new Error(\"El archivo jsonl no fue encontrado: \"+err)\r\n                })\r\n            })            \r\n\r\n        } catch(err) {\r\n            reject(err)\r\n        }\r\n    })\r\n}","import { generarTextEditor } from \"./components/texteditor\";\r\nimport { createDiv, createElement } from \"./components/utils\";\r\nimport { loadData } from \"./utils/loadDocument\";\r\ndeclare const sessions: string[];\r\n\r\nfunction generarSamplesFromArray(raw: Float32Array, samples = 400) {\r\n    const blockSize = Math.floor(raw.length/samples);\r\n    const filtered = [];\r\n    for (let i = 0; i < samples; i++) {\r\n        let start = blockSize * i;\r\n        let sum = 0;\r\n        for (let j = 0; j < blockSize; j++) {\r\n            sum += Math.abs(raw[start+j])\r\n        }\r\n        filtered.push(sum/blockSize)\r\n    }\r\n    const multiplier = Math.pow(Math.max(...filtered), -1);\r\n    const normalized = filtered.map(n => {\r\n        return n * multiplier\r\n    })\r\n    return normalized\r\n}\r\nfunction generarSamples(audioBuffer: AudioBuffer, samples = 400) {\r\n    const raw = audioBuffer.getChannelData(0);\r\n    return generarSamplesFromArray(raw, samples)\r\n}\r\nfunction decodeAudio(buffer) {\r\n    var context = new AudioContext();\r\n    return context.decodeAudioData(buffer)\r\n    .then(audioBuffer => {\r\n        return audioBuffer\r\n    })\r\n}\r\n\r\nfunction drawHorizontal(canvas: HTMLCanvasElement, normalizedData: number[]) {\r\n    const dpr = window.devicePixelRatio || 1;    \r\n    const padding = 10;\r\n    canvas.width = canvas.offsetWidth * dpr;\r\n    canvas.height = (canvas.offsetHeight + padding * 2 ) * dpr;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    ctx.clearRect(0,0,canvas.width, canvas.height)\r\n    ctx.scale(dpr, dpr);\r\n    ctx.translate( 0, canvas.offsetHeight / 2 + padding); \r\n\r\n\r\n    const width = canvas.offsetWidth / normalizedData.length;\r\n    ctx.fillStyle = \"#e7534b\";\r\n    for (let i = 0; i < normalizedData.length; i++) {\r\n        let x = width * i;\r\n        let h = normalizedData[i] * canvas.offsetHeight - padding\r\n        if (h<3) h = 1;\r\n        if (i%2 == 0 && h > 1) h = -h;\r\n\r\n        ctx.fillRect(x,0,width,h)\r\n\r\n    }\r\n}\r\n\r\nasync function build(sessionId: string) { \r\n    var [blob, doc] = await loadData(sessionId);\r\n  \r\n    if (!blob && blob.size < 1000) return;\r\n    console.log(blob.size)\r\n\r\n\r\n    var div = createDiv({width: 500, margin: \"0 auto\"})  \r\n    const visualization = createDiv(\"row\")\r\n    const canvas = document.createElement(\"canvas\");\r\n    canvas.classList.add(\"flex\")\r\n    canvas.style.width = \"100%\";\r\n    canvas.style.height = \"100px\";\r\n    visualization.append(canvas);\r\n    div.append(visualization)\r\n\r\n    const photo = createDiv({height: 150, width: \"100%\", background: \"#00000022\", margin: \"30px auto\"})\r\n    \r\n    let img = createElement(\"img\", {width: \"100%\"}) as HTMLImageElement;\r\n    if (doc.photoUrl) img.src = doc.photoUrl;\r\n    photo.append(img)\r\n    \r\n    photo.onclick = () => {\r\n        let input = createElement(\"input\") as HTMLInputElement;\r\n        input.type = \"file\";\r\n        input.accept = \"image/jpeg\"\r\n        input.onchange = (e: any) => {\r\n            let image_file = e.target.files[0];\r\n            var form = new FormData();\r\n            form.append(\"file\", image_file);\r\n            fetch(`/api/images/${doc.roomId}`, {method: \"POST\", body: form})\r\n            .then(r => r.json()).then(res => {\r\n                doc.photoUrl = res.result;\r\n                img.src = doc.photoUrl;\r\n                doc.save().then(console.log, console.error)\r\n               \r\n                \r\n            }, console.error)\r\n        }\r\n        input.click()\r\n    }\r\n    div.append(photo)\r\n\r\n    const audioControls = createDiv(\"row center\", {marginTop: 10}); \r\n    const playPauseButton = createElement(\"button\", {width: 100, height: 50});\r\n    playPauseButton.innerText = \"Play\";\r\n    audioControls.append(playPauseButton);\r\n    const downloadAudioButton = createElement(\"button\", {width: 140, height: 50, marginLeft: 10});\r\n    downloadAudioButton.innerText = \"Download\";\r\n    audioControls.append(downloadAudioButton);\r\n\r\n\r\n    div.append(audioControls)\r\n    document.body.append(div);\r\n\r\n    \r\n    const audioBuffer = await decodeAudio(await blob.arrayBuffer());\r\n    const normalized = generarSamples(audioBuffer);\r\n    drawHorizontal(canvas, normalized)  \r\n\r\n\r\n    let editor = generarTextEditor(doc, document.body);\r\n    var context = new AudioContext();\r\n    var source: AudioBufferSourceNode\r\n\r\n    canvas.onmousemove = e => {\r\n        drawHorizontal(canvas, normalized)  \r\n        var ctx = canvas.getContext(\"2d\");\r\n        ctx.strokeStyle = \"#e7534b\";\r\n        ctx.lineWidth = 3;\r\n        ctx.moveTo(e.offsetX, -canvas.height/2)\r\n        ctx.lineTo(e.offsetX, canvas.height/2)\r\n        ctx.stroke()\r\n\r\n\r\n        let progress = e.offsetX/canvas.width;\r\n        let segundos = audioBuffer.duration * progress ;\r\n\r\n\r\n        var after_this = doc.near(segundos)\r\n        if (after_this.length) {\r\n            editor.clearMark().mark(after_this[0].id.toString())\r\n        } \r\n    }   \r\n\r\n    function playAudio(offset: number) {\r\n        if (source) source.stop()\r\n        playPauseButton.innerText = \"Stop\"\r\n        source = context.createBufferSource()\r\n        source.buffer = audioBuffer;\r\n        source.connect(context.destination)\r\n        source.start(0, offset)\r\n    }\r\n    canvas.onclick = (e) => {\r\n        let progress = e.offsetX/canvas.width;\r\n        let segundos = audioBuffer.duration * progress ;\r\n        \r\n        var target = doc.near(segundos)\r\n        if (target.length) playAudio( target[0].id / 10000000)\r\n    }\r\n    playPauseButton.onclick = () => {\r\n        if (source) {\r\n            source.stop()\r\n            source = null;\r\n            playPauseButton.innerText = \"Play\"\r\n        } else playAudio(0)\r\n    }\r\n    downloadAudioButton.onclick = () => {\r\n        var a = document.createElement(\"a\");\r\n        document.body.appendChild(a);\r\n        a.style.display = \"none\";\r\n        let url = window.URL.createObjectURL(blob)\r\n        a.href = url;\r\n        a.download = doc.roomId+\".webm\";\r\n        a.click()\r\n        window.URL.revokeObjectURL(url)\r\n        document.body.removeChild(a)\r\n    }\r\n\r\n}\r\n\r\nfor (var sessionId of sessions) {\r\n    build(sessionId)\r\n}\r\n\r\n","export interface IMsg {\r\n    result: string,\r\n    id: number, \r\n    speakerId: string\r\n}\r\n\r\n\r\nexport class TranscriptionDocument {\r\n    roomId: string = \"\";\r\n    itemes: IMsg[] = [];\r\n    photoUrl: string = \"\";\r\n    constructor(roomIdOrDocument: string | TranscriptionDocument, itemes: IMsg[] = []) {\r\n        if (typeof roomIdOrDocument == \"string\") {\r\n            this.roomId = roomIdOrDocument;\r\n            this.itemes = itemes;\r\n        } else {\r\n            this.roomId = roomIdOrDocument.roomId;\r\n            this.itemes = roomIdOrDocument.itemes || itemes;\r\n            this.photoUrl = roomIdOrDocument.photoUrl;\r\n        }\r\n\r\n    }\r\n    near(second: number) {\r\n        let candidates = this.itemes.filter(f => {\r\n            return f.id > second*10000000;\r\n        })\r\n        if (candidates.length) return candidates;\r\n        else if (this.itemes.length) return [this.itemes[this.itemes.length-1]]\r\n        return []\r\n    }\r\n    clean() {\r\n        var times = {}\r\n        for (let m of this.itemes) {\r\n            times[m.id] = m\r\n        }\r\n        this.itemes = Object.values(times)\r\n    }\r\n    get(id: string) {\r\n        return this.itemes.find(f => f.id.toString() == id)\r\n    }\r\n    save() {\r\n        return fetch(`/api/transcripcion/${this.roomId}`, {method: \"POST\", headers: {\"Content-Type\": \"application/json\"}, body: JSON.stringify(this)}).then(r => r.json())\r\n    }\r\n}\r\n"]}